###################################################################################
# TB Makefile for R4
###################################################################################
include $(R4_TB_PATH)/r4_tb.mak

###################################################################################
# Standard Targets
###################################################################################
.PHONY: all clean

###################################################################################
# TB VPATH:
###################################################################################
VPATH = $(R4_TB_PATH)/source

###################################################################################
# Source Files:
###################################################################################
R4_TB_C_SOURCES = main.c csl.c uart.c xmodem.c xmodem_test.c uart_test.c
R4_TB_ASM_SOURCES = startupasm.asm
R4_UFTB_C_SOURCES = r4_init.c main_uniflash.c csl.c uart.c ProcessorSDKSerialFlash.c

###################################################################################
# C Objects
###################################################################################
R4_TB_C_SRC_OBJECTS  = $(addprefix $(OBJDIR)/, $(R4_TB_C_SOURCES:.c=.$(R4_OBJ_EXT)))
R4_UFTB_C_SRC_OBJECTS  = $(addprefix $(OBJDIR)/, $(R4_UFTB_C_SOURCES:.c=.$(R4_OBJ_EXT)))

###################################################################################
# Assembly Objects
###################################################################################
R4_TB_ASM_SRC_OBJECTS  = $(addprefix $(OBJDIR)/, $(R4_TB_ASM_SOURCES:.asm=.$(R4_OBJ_EXT)))

###################################################################################
# Object List:
###################################################################################
R4_TB_OBJECTS  = $(R4_TB_C_SRC_OBJECTS) $(R4_TB_ASM_SRC_OBJECTS)
R4_UFTB_OBJECTS  = $(R4_UFTB_C_SRC_OBJECTS) $(R4_TB_ASM_SRC_OBJECTS)

###################################################################################
# C Dependencies
###################################################################################
R4_TB_C_SRC_DEP = $(addprefix $(OBJDIR)/, $(R4_TB_C_SOURCES:.c=.$(R4_DEP_EXT)))
R4_UFTB_C_SRC_DEP = $(addprefix $(OBJDIR)/, $(R4_UFTB_C_SOURCES:.c=.$(R4_DEP_EXT)))

###################################################################################
# Assembly Dependencies
###################################################################################
R4_TB_ASM_SRC_DEP  = $(addprefix $(OBJDIR)/, $(R4_TB_ASM_SOURCES:.asm=.$(R4_DEP_EXT)))

###################################################################################
# Dependency List:
###################################################################################
R4_TB_DEPENDS  = $(R4_TB_ASM_SRC_DEP) $(R4_TB_C_SRC_DEP)
R4_UFTB_DEPENDS  = $(R4_TB_ASM_SRC_DEP) $(R4_UFTB_C_SRC_DEP)

###################################################################################
# R4 TB Definitions:
###################################################################################
R4_TB_LINKER_CMD  = $(R4_TB_PATH)/linker_r4.cmd
R4_TB_MAP_FILE    = $(R4_TB_PATH)/r4_tb.map
R4_TB_OUT_FILE    = $(R4_TB_PATH)/r4_tb.$(R4_EXE_EXT)

###################################################################################
# R4 UniFlash Definitions:
###################################################################################
R4_UFTB_LINKER_CMD  = $(R4_TB_PATH)/linker_r4.cmd
R4_UFTB_MAP_FILE    = $(R4_TB_PATH)/r4_uftb.map
R4_UFTB_OUT_FILE    = $(R4_TB_PATH)/r4_uftb.$(R4_EXE_EXT)

###################################################################################
# Build the R4 TB Image
###################################################################################
r4TBBuild:
	@echo "********************************************************************"
	@echo "Building R4 Testbench Image"
	@echo "********************************************************************"
	$(R4_LD) $(R4_LDFLAGS)           			\
	$(R4_TB_OBJECTS)						\
	$(R4_LD_RTS_FLAGS)							\
	--map_file=$(R4_TB_MAP_FILE) 	\
	$(R4_TB_LINKER_CMD)          	\
	-o $(R4_TB_OUT_FILE)             \

###################################################################################
# Build the R4 UNIFLASH TB Image
###################################################################################
r4UniFlashTBBuild:
	@echo "********************************************************************"
	@echo "Building R4 UniFlash Testbench Image"
	@echo "********************************************************************"
	$(R4_LD) $(R4_LDFLAGS)    			\
	$(R4_UFTB_OBJECTS)							\
	$(R4_LD_RTS_FLAGS)							\
	--map_file=$(R4_UFTB_MAP_FILE) 				\
	$(R4_UFTB_LINKER_CMD)          				\
	-o $(R4_UFTB_OUT_FILE)             			\

all: buildDirectories $(R4_TB_OBJECTS) $(R4_UFTB_OBJECTS) r4TBBuild r4UniFlashTBBuild

###################################################################################
# Clean the R4 TB
###################################################################################
clean:
	@echo "********************************************************************"
	@echo "Cleaning R4 Testbench build"
	@echo "********************************************************************"
	@$(DEL) $(R4_TB_OBJECTS)
	@$(DEL) $(R4_TB_MAP_FILE)
	@$(DEL) $(R4_TB_OUT_FILE)  
	@$(DEL) $(R4_TB_DEPENDS)
	@echo "********************************************************************"
	@echo "Cleaning R4 Uniflash Testbench build"
	@echo "********************************************************************"	
	@$(DEL) $(R4_UFTB_OBJECTS)	
	@$(DEL) $(R4_UFTB_MAP_FILE)	
	@$(DEL) $(R4_UFTB_OUT_FILE)	
	@$(DEL) $(R4_UFTB_DEPENDS)	
	@$(DEL) $(OBJDIR)

###################################################################################
# Dependency handling
###################################################################################
-include $(R4_TB_DEPENDS)
-include $(R4_UFTB_DEPENDS)
